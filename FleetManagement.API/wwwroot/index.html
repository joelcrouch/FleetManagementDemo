<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .navbar {
            margin-bottom: 30px;
        }

        .stat-card {
            transition: transform 0.2s;
        }

            .stat-card:hover {
                transform: translateY(-5px);
            }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .loading {
            text-align: center;
            padding: 50px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">🚗 Fleet Management System</span>
            <span class="text-white">ODOT Portfolio Project</span>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>Dashboard</h2>
            </div>
        </div>

        <div id="statsContainer" class="row mb-5">
            <div class="col-12 loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Vehicle List -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>Vehicle Fleet</h2>
            </div>
        </div>

        <div class="table-container mb-5">
            <div class="mb-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVehicleModal">
                    + Add Vehicle
                </button>
                <button class="btn btn-warning" onclick="testSlowEndpoint()">
                    Test Slow Endpoint (3s delay)
                </button>
                <button class="btn btn-danger" onclick="testErrorEndpoint()">
                    Test Error Endpoint (50% fail)
                </button>
            </div>
            <div id="vehicleTableContainer">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>

        <!-- Recent Maintenance -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>Recent Maintenance</h2>
            </div>
        </div>

        <div class="table-container">
            <div id="maintenanceContainer">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>

        <!-- Database Health -->
        <div class="row mb-4">
            <div class="col-12">
                <h2>Database Health</h2>
                <button class="btn btn-info mb-3" onclick="loadDatabaseHealth()">Refresh Database Health</button>
                <div class="table-container">
                    <div id="databaseHealthContainer">
                        <div class="loading">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div class="modal fade" id="addVehicleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Vehicle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addVehicleForm">
                        <div class="mb-3">
                            <label class="form-label">VIN</label>
                            <input type="text" class="form-control" id="vin" required maxlength="17" minlength="17">
                            <small class="text-muted">Must be exactly 17 characters</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Make</label>
                            <input type="text" class="form-control" id="make" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Model</label>
                            <input type="text" class="form-control" id="model" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Year</label>
                            <input type="number" class="form-control" id="year" required min="1900" max="2025">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mileage</label>
                            <input type="number" class="form-control" id="mileage" required min="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-control" id="department">
                                <option>Transportation</option>
                                <option>Maintenance</option>
                                <option>Admin</option>
                                <option>Field Operations</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addVehicle()">Add Vehicle</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>const API_BASE = window.location.origin;

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            loadVehicles();
            loadMaintenance();
            loadDatabaseHealth(); 
        });

        // Load Dashboard Stats
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/dashboard/stats`);
                const data = await response.json();

                document.getElementById('statsContainer').innerHTML = `
                    <div class="col-md-3">
                        <div class="card stat-card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">Total Vehicles</h5>
                                <h2>${data.totalVehicles}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">Active Vehicles</h5>
                                <h2>${data.activeVehicles}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-warning text-white">
                            <div class="card-body">
                                <h5 class="card-title">In Maintenance</h5>
                                <h2>${data.vehiclesInMaintenance}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-danger text-white">
                            <div class="card-body">
                                <h5 class="card-title">Unresolved Alerts</h5>
                                <h2>${data.unresolvedAlerts}</h2>
                                <small>Critical: ${data.criticalAlerts}</small>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load Vehicles
        async function loadVehicles() {
            try {
                const response = await fetch(`${API_BASE}/api/vehicles`);
                const vehicles = await response.json();

                let html = `
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>VIN</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>Year</th>
                                <th>Mileage</th>
                                <th>Status</th>
                                <th>Department</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                vehicles.slice(0, 20).forEach(v => {
                    const statusBadge = v.status === 'Active' ? 'success' :
                                       v.status === 'Maintenance' ? 'warning' : 'secondary';
                    html += `
                        <tr>
                            <td><small>${v.vin}</small></td>
                            <td>${v.make}</td>
                            <td>${v.model}</td>
                            <td>${v.year}</td>
                            <td>${v.mileage.toLocaleString()}</td>
                            <td><span class="badge bg-${statusBadge}">${v.status}</span></td>
                            <td>${v.department || 'N/A'}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    <p class="text-muted">Showing 20 of ${vehicles.length} vehicles</p>
                `;

                document.getElementById('vehicleTableContainer').innerHTML = html;
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }

        // Load Recent Maintenance
        async function loadMaintenance() {
            try {
                const response = await fetch(`${API_BASE}/api/maintenance`);
                const records = await response.json();

                let html = `
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vehicle ID</th>
                                <th>Service Type</th>
                                <th>Cost</th>
                                <th>Performed By</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                records.slice(0, 10).forEach(m => {
                    const date = new Date(m.serviceDate).toLocaleDateString();
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>#${m.vehicleId}</td>
                            <td>${m.serviceType}</td>
                            <td>$${m.cost.toFixed(2)}</td>
                            <td>${m.performedBy || 'N/A'}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    <p class="text-muted">Showing 10 most recent maintenance records</p>
                `;

                document.getElementById('maintenanceContainer').innerHTML = html;
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        // Add Vehicle
        async function addVehicle() {
            const vehicle = {
                vin: document.getElementById('vin').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                year: parseInt(document.getElementById('year').value),
                mileage: parseInt(document.getElementById('mileage').value),
                department: document.getElementById('department').value,
                status: 'Active',
                dateAcquired: new Date().toISOString(),
                lastServiceDate: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE}/api/vehicles`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(vehicle)
                });

                if (response.ok) {
                    alert('Vehicle added successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('addVehicleModal')).hide();
                    document.getElementById('addVehicleForm').reset();
                    loadVehicles();
                    loadDashboard();
                } else {
                    alert('Error adding vehicle');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding vehicle');
            }
        }

        // Test Slow Endpoint
        async function testSlowEndpoint() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';

            const start = Date.now();
            try {
                await fetch(`${API_BASE}/api/vehicles/slow`);
                const duration = ((Date.now() - start) / 1000).toFixed(1);
                alert(`Slow endpoint completed in ${duration}s (should be ~3s). Check logs!`);
            } catch (error) {
                alert('Error calling slow endpoint');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Test Slow Endpoint (3s delay)';
            }
        }

        // Test Error Endpoint
        async function testErrorEndpoint() {
            try {
                const response = await fetch(`${API_BASE}/api/vehicles/error`);
                if (response.ok) {
                    alert('Success! (50% chance - try again to trigger error)');
                } else {
                    alert('Error thrown! Check your logs to see the error captured.');
                }
            } catch (error) {
                alert('Error thrown! Check your logs to see the error captured.');
            }
        }

            // Load Database Health Info
        async function loadDatabaseHealth() {
            const container = document.getElementById('databaseHealthContainer');
            container.innerHTML = `
    <div class="loading">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
`;

            try {
                const response = await fetch(`${API_BASE}/api/admin/database-health`);
                const data = await response.json();

                let html = "";
                for (const [section, rows] of Object.entries(data)) {
                    html += `
            <h5 class="mt-3">${section}</h5>
            <pre class="bg-light p-3 rounded border" style="max-height: 300px; overflow-y: auto;">
${JSON.stringify(rows, null, 2)}
            </pre>
        `;
                }

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading database health:', error);
                container.innerHTML = `
        <div class="alert alert-danger">
            Failed to load database diagnostics. Check server logs.
        </div>
    `;
            }
        

        }</script>
</body>
</html>